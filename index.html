<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calendario Vacaciones</title>
<link rel="icon" href="playa.png" type="image/png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<style>
  :root {
    --bg: #f0f4f8; --card-bg: #ffffff; --text: #2d3748; --border: #e2e8f0;
    --primary: #4c6ef5; --vacation: #22c55e; --vacation-prev: #0ea5e9;
    --medical: #3b82f6; --holiday-national: #ef4444; --holiday-local: #a855f7;
    --weekend: #dbeafe; --shadow: 0 6px 16px rgba(0,0,0,0.08);
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a202c; --card-bg: #2d3748; --text: #e2e8f0; --border: #4a5568;
      --vacation: #4ade80; --vacation-prev: #38bdf8; --medical: #60a5fa;
      --holiday-national: #f87171; --holiday-local: #c084fc; --weekend: #6366f1;
      --shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 1.5rem 1rem; line-height: 1.6; transition: background 0.3s; }

  /* --- ESTILOS LOGIN --- */
  #authSection { max-width: 400px; margin: 50px auto; padding: 2.5rem; background: var(--card-bg); border-radius: 24px; box-shadow: var(--shadow); text-align: center; }
  .auth-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; }
  .auth-btn { width: 100%; padding: 13px; margin: 10px 0; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
  .btn-email { background: var(--primary); color: white; }
  .btn-phone { background: #22c55e; color: white; }
  .btn-anon { background: transparent; border: 1px solid var(--border); color: var(--text); }

  /* --- ESTILOS CALENDARIO --- */
  h1 { text-align: center; font-size: 2.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--primary); }
  .user-info { text-align: center; margin-bottom: 1.8rem; font-size: 0.85rem; opacity: 0.8; }
  .logout-link { color: #e53e3e; cursor: pointer; text-decoration: underline; margin-left: 10px; }
  .sync-status { font-size: 0.75rem; color: var(--vacation); font-weight: bold; margin-top: 5px; display: block; }
  
  .year-selector { text-align: center; margin-bottom: 1.5rem; }
  .year-selector button { padding: 0.6rem 1.2rem; margin: 0 0.4rem; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); border-radius: 12px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
  .year-selector button:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .year-selector input { padding: 0.6rem; width: 100px; text-align: center; border: 1px solid var(--border); background: var(--card-bg); border-radius: 12px; font-size: 1.1rem; font-weight: 500; }
  
  .counters { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; margin: 1.5rem 0; }
  .counter-box { background: var(--card-bg); padding: 0.9rem 0.8rem; border-radius: 14px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border); }
  .counter-box div { font-size: 0.8rem; opacity: 0.85; margin-bottom: 0.4rem; font-weight: 500; }
  .counter-box strong { font-size: 1.6rem; font-weight: 700; }
  .big-remaining { font-size: 2rem !important; color: var(--primary); }
  
  #resetYear { display: block; margin: 1.8rem auto; padding: 0.8rem 1.8rem; background: #e53e3e; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: var(--shadow); }
  
  .labels { display: flex; justify-content: center; gap: 1rem; margin: 1.5rem 0; flex-wrap: wrap; font-size: 0.9rem; font-weight: 500; }
  .labels span { display: flex; align-items: center; gap: 0.5rem; }
  .dot { width: 0.9rem; height: 0.9rem; border-radius: 50%; display: inline-block; }
  
  .calendar { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; width: 100%; }
  .month { background: var(--card-bg); border-radius: 20px; padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border); }
  .month h2 { text-align: center; margin-bottom: 1rem; font-size: 1.4rem; font-weight: 600; color: var(--primary); }
  .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; font-size: 0.9rem; }
  .day { height: 46px; display: flex; align-items: center; justify-content: center; border-radius: 14px; cursor: pointer; transition: all 0.3s; font-weight: 500; border: 1px solid transparent; position: relative; overflow: hidden; }
  .day:hover { transform: scale(1.08); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
  .vacation { background: var(--vacation); color: white; }
  .vacation-prev { background: var(--vacation-prev); color: white; }
  .medical { background: var(--medical); color: white; }
  .holiday-national { background: var(--holiday-national); color: white; }
  .holiday-local { background: var(--holiday-local); color: white; }
  .weekend { background: var(--weekend); color: var(--text); opacity: 0.9; }
  .today { border: 4px solid var(--primary) !important; font-weight: bold; box-shadow: 0 0 20px rgba(76, 110, 245, 0.4); }
  .badge-an { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-radius: 8px; pointer-events: none; }
  .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #2d3748; color: white; padding: 0.7rem 1rem; border-radius: 10px; font-size: 0.85rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10; margin-bottom: 10px; }
  .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border: 6px solid transparent; border-top-color: #2d3748; }
  .day.holiday-national:hover .tooltip, .day.holiday-local:hover .tooltip { opacity: 1; }
</style>
</head>
<body>

  <div id="authSection">
    <h2 style="margin-bottom: 10px; color: var(--primary);">Bienvenido</h2>
    <p style="font-size: 0.9rem; margin-bottom: 20px;">Gestiona tus vacaciones en la nube</p>
    
    <input type="email" id="email" class="auth-input" placeholder="Correo electrónico">
    <input type="password" id="pass" class="auth-input" placeholder="Contraseña">
    <button onclick="loginEmail()" class="auth-btn btn-email">Entrar / Registrar Email</button>

    <div style="margin: 20px 0; border-top: 1px solid var(--border);"></div>

    <div id="recaptcha-container"></div>
    <input type="text" id="phone" class="auth-input" placeholder="+34 600 000 000">
    <button onclick="loginTelefono()" class="auth-btn btn-phone">Entrar con Teléfono</button>

    <button onclick="loginAnonimo()" class="auth-btn btn-anon" style="margin-top: 10px;">Entrar como Invitado</button>
  </div>

  <div id="calendarSection" style="display: none;">
    <h1>Calendario Vacaciones</h1>
    <div class="user-info">
      Usuario: <span id="userTag" style="font-weight: 600;"></span>
      <span class="logout-link" onclick="logout()">Cerrar sesión</span>
      <span id="syncText" class="sync-status">Sincronizado</span>
    </div>

    <div class="year-selector">
      <button id="prevYear">« Año anterior</button>
      <input type="number" id="yearInput" value="2026" min="2000" max="2100">
      <button id="nextYear">Año siguiente »</button>
    </div>

    <div class="counters">
      <div class="counter-box">
        <div>Días usados (año actual)</div>
        <strong id="vacationCount">0</strong>
      </div>
      <div class="counter-box">
        <div>Días año anterior usados</div>
        <strong id="vacationPrevCount">0</strong>
      </div>
      <div class="counter-box">
        <div>Días médicos</div>
        <strong id="medicalCount">0</strong>
      </div>
      <div class="counter-box">
        <div>Días totales disponibles</div>
        <strong id="remaining" class="big-remaining">23</strong>
      </div>
    </div>

    <button id="resetYear">Borrar todas las marcas de este año</button>

    <div class="labels">
      <span><span class="dot" style="background:var(--vacation);"></span> Vacaciones año actual</span>
      <span><span class="dot" style="background:var(--vacation-prev);"></span> Vacaciones año anterior (AN)</span>
      <span><span class="dot" style="background:var(--medical);"></span> Médico</span>
      <span><span class="dot" style="background:var(--holiday-national);"></span> Festivo Nacional</span>
      <span><span class="dot" style="background:var(--holiday-local);"></span> Festivo Local / Trasladado</span>
    </div>

    <div class="calendar" id="calendar"></div>
  </div>

<script>
// === CONFIGURACIÓN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyD9zUGS1BuBiGYQ0yAj26qnUT2CggYBlhA",
  authDomain: "calendario-vacaciones-b7825.firebaseapp.com",
  projectId: "calendario-vacaciones-b7825",
  storageBucket: "calendario-vacaciones-b7825.firebasestorage.app",
  messagingSenderId: "472325131890",
  appId: "1:472325131890:web:03daa8176ac7ac5fddbceb"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let userId = null;

// Recaptcha invisible para SMS
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });

// --- LÓGICA DE AUTENTICACIÓN ---

firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    userId = user.uid;
    document.getElementById('userTag').textContent = user.email || user.phoneNumber || "Invitado";
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('calendarSection').style.display = 'block';
    loadData(); // Cargar datos inmediatamente al entrar
  } else {
    userId = null;
    document.getElementById('authSection').style.display = 'block';
    document.getElementById('calendarSection').style.display = 'none';
  }
});

function loginEmail() {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('pass').value;
  if(!email || !pass) return alert("Rellena email y contraseña");
  firebase.auth().signInWithEmailAndPassword(email, pass)
    .catch(() => firebase.auth().createUserWithEmailAndPassword(email, pass))
    .catch(e => alert(e.message));
}

function loginTelefono() {
  const phone = document.getElementById('phone').value;
  if(!phone.startsWith('+')) return alert("Usa formato internacional (+34...)");
  firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier)
    .then(confirmRes => {
      const code = prompt("Código recibido por SMS:");
      return confirmRes.confirm(code);
    }).catch(e => alert(e.message));
}

function loginAnonimo() {
  firebase.auth().signInAnonymously();
}

function logout() {
  firebase.auth().signOut();
}

// --- LÓGICA DEL CALENDARIO ---

let currentYear = 2026;
const vacationLimit = 23;
let yearData = {};      
let carryOver = {};     

const vacationCount = document.getElementById("vacationCount");
const vacationPrevCount = document.getElementById("vacationPrevCount");
const medicalCount = document.getElementById("medicalCount");
const remaining = document.getElementById("remaining");
const yearInput = document.getElementById("yearInput");
const calendar = document.getElementById("calendar");
const syncText = document.getElementById("syncText");

const dayNames = ["L","M","X","J","V","S","D"];
const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

// --- CARGA Y GUARDADO CON NUBE ---
function loadData() {
  if (!userId) return;
  syncText.textContent = "Cargando...";
  syncText.style.color = "orange";

  db.collection("calendarios").doc(userId).get().then((doc) => {
    if (doc.exists) {
      const data = doc.data();
      yearData = convertToSets(data.yearData || {});
      carryOver = data.carryOver || {};
    }
    createCalendar(currentYear);
    syncText.textContent = "Sincronizado";
    syncText.style.color = "var(--vacation)";
  }).catch((e) => {
    console.error(e);
    syncText.textContent = "Error de conexión";
    syncText.style.color = "red";
    createCalendar(currentYear);
  });
}

function saveData() {
  if (!userId) return;
  syncText.textContent = "Guardando...";
  syncText.style.color = "orange";

  db.collection("calendarios").doc(userId).set({
    yearData: convertToArrays(yearData),
    carryOver: carryOver,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    syncText.textContent = "Sincronizado";
    syncText.style.color = "var(--vacation)";
  }).catch((e) => {
    syncText.textContent = "Error al guardar";
    syncText.style.color = "red";
  });
}

function convertToSets(data) {
  const converted = {};
  for (const y in data) {
    converted[y] = {
      vacation: new Set(data[y].vacation || []),
      vacationPrev: new Set(data[y].vacationPrev || []),
      medical: new Set(data[y].medical || [])
    };
  }
  return converted;
}
function convertToArrays(data) {
  const converted = {};
  for (const y in data) {
    converted[y] = {
      vacation: Array.from(data[y].vacation),
      vacationPrev: Array.from(data[y].vacationPrev),
      medical: Array.from(data[y].medical)
    };
  }
  return converted;
}

// LÓGICA DE FESTIVOS (LEÓN)
function getFixedHolidays(year){
  const fixed = [
    {month:1,day:1},{month:1,day:6},{month:5,day:1},
    {month:8,day:15},{month:10,day:12},{month:11,day:1},
    {month:12,day:6},{month:12,day:8},{month:12,day:25}
  ];
  return fixed.map(f=>{
    let date = new Date(year, f.month-1, f.day);
    if (f.month === 10 && f.day === 12 && date.getDay() === 0) date.setDate(13);
    return `${year}-${date.getMonth()+1}-${date.getDate()}`;
  });
}

function getEasterSunday(year){
  const f=Math.floor,G=year%19,C=f(year/100),H=(C-f(C/4)-f((8*C+13)/25)+19*G+15)%30,
  I=H-f(H/28)*(1-f(H/28)*f(29/(H+1))*f((21-G)/11)),J=(year+f(year/4)+I+2-C+f(C/4))%7,
  L=I-J,month=3+f((L+40)/44),day=L+28-31*f(month/4);
  return new Date(year,month-1,day);
}

function getEasterRelatedHolidays(year){
  const easter=getEasterSunday(year);
  const thursday=new Date(easter); thursday.setDate(easter.getDate()-3);
  const friday=new Date(easter); friday.setDate(easter.getDate()-2);
  return [`${year}-${thursday.getMonth()+1}-${thursday.getDate()}`,`${year}-${friday.getMonth()+1}-${friday.getDate()}`];
}

function getLocalAndTransferredHolidays(year){
  const holidays = new Set();
  holidays.add(`${year}-4-23`);
  holidays.add(`${year}-6-24`);
  let sanFroilan = new Date(year, 9, 5);
  if (sanFroilan.getDay() === 0) sanFroilan.setDate(6);
  holidays.add(`${year}-${sanFroilan.getMonth()+1}-${sanFroilan.getDate()}`);
  if (new Date(year, 11, 6).getDay() === 0) holidays.add(`${year}-12-7`);
  if (new Date(year, 10, 1).getDay() === 0) holidays.add(`${year}-11-2`);
  return holidays;
}

function getHolidaySets(year){
  return { 
    national: new Set([...getFixedHolidays(year), ...getEasterRelatedHolidays(year)]),
    local: getLocalAndTransferredHolidays(year)
  };
}

function calculateCarryOver(year) {
  if (carryOver[year] !== undefined) return carryOver[year];
  if (!yearData[year]) return 0;
  const data = yearData[year];
  const totalUsed = data.vacation.size + data.vacationPrev.size;
  const prevCarry = year > 2025 ? calculateCarryOver(year - 1) : 0;
  const leftover = (vacationLimit + prevCarry) - totalUsed;
  carryOver[year] = Math.max(0, leftover);
  return carryOver[year];
}

function ensureCarryOverUpTo(prevYear) {
  for (let y = 2025; y <= prevYear; y++) calculateCarryOver(y);
}

function createCalendar(year){
  currentYear = year;
  yearInput.value = year;
  ensureCarryOverUpTo(year - 1);
  const holidays = getHolidaySets(year);
  
  if (!yearData[year]) yearData[year] = { vacation: new Set(), vacationPrev: new Set(), medical: new Set() };
  
  calendar.innerHTML = "";
  for(let m = 0; m < 12; m++){
    const totalDays = new Date(year, m+1, 0).getDate();
    const monthDiv = document.createElement("div");
    monthDiv.className = "month";
    monthDiv.innerHTML = `<h2>${months[m]}</h2>`;
    const daysDiv = document.createElement("div");
    daysDiv.className = "days";

    dayNames.forEach(d => {
      const label = document.createElement("div");
      label.className = "day"; label.style.fontWeight = "bold"; label.textContent = d;
      daysDiv.appendChild(label);
    });

    const startDay = (new Date(year, m, 1).getDay() + 6) % 7;
    for(let i = 0; i < startDay; i++) daysDiv.appendChild(document.createElement("div"));

    for(let d = 1; d <= totalDays; d++){
      const dateKey = `${year}-${m+1}-${d}`;
      const dayDiv = document.createElement("div");
      dayDiv.className = "day";
      dayDiv.dataset.date = dateKey;
      dayDiv.innerHTML = `<span>${d}</span>`;
      
      const dayOfWeek = new Date(year, m, d).getDay();
      const isToday = (dateKey === `${new Date().getFullYear()}-${new Date().getMonth()+1}-${new Date().getDate()}`);
      if (isToday) dayDiv.classList.add("today");

      if (holidays.national.has(dateKey)) {
        dayDiv.classList.add("holiday-national");
        dayDiv.innerHTML += `<div class="tooltip">Festivo Nacional</div>`;
      } else if (holidays.local.has(dateKey)) {
        dayDiv.classList.add("holiday-local");
        dayDiv.innerHTML += `<div class="tooltip">Festivo León / Trasladado</div>`;
      } else if (dayOfWeek === 0 || dayOfWeek === 6) {
        dayDiv.classList.add("weekend");
      } else {
        dayDiv.onclick = () => handleDayClick(dayDiv, year, m, d);
      }

      if (yearData[year].vacation.has(dateKey)) dayDiv.classList.add("vacation");
      if (yearData[year].medical.has(dateKey)) dayDiv.classList.add("medical");
      if (yearData[year].vacationPrev.has(dateKey)) {
        dayDiv.classList.add("vacation-prev");
        dayDiv.innerHTML += `<div class="badge-an">AN</div>`;
      }
      daysDiv.appendChild(dayDiv);
    }
    monthDiv.appendChild(daysDiv);
    calendar.appendChild(monthDiv);
  }
  updateCounters();
}

function handleDayClick(dayDiv, year, month, day){
  const dateKey = `${year}-${month+1}-${day}`;
  const data = yearData[year];
  
  data.vacation.delete(dateKey); data.vacationPrev.delete(dateKey); data.medical.delete(dateKey);

  const type = prompt("¿Qué quieres marcar? (v = vacaciones, m = médico, c = borrar)").toLowerCase();
  if (type === "m") {
    data.medical.add(dateKey);
  } else if (type === "v") {
    const carry = calculateCarryOver(year - 1);
    const remainingCarry = carry - data.vacationPrev.size;
    let usePrev = (remainingCarry > 0) && confirm(`Usar día de año anterior? (Quedan ${remainingCarry})`);

    const dow = new Date(year, month, day).getDay();
    let markWeek = (dow >= 1 && dow <= 5) && confirm("¿Marcar hasta el viernes?");
    
    let daysToMark = [dateKey];
    if(markWeek) {
      for(let i=dow+1; i<=5; i++) {
        let tempDate = new Date(year, month, day + (i - dow));
        let tempKey = `${year}-${tempDate.getMonth()+1}-${tempDate.getDate()}`;
        daysToMark.push(tempKey);
      }
    }

    daysToMark.forEach(k => {
      if(usePrev && (calculateCarryOver(year-1) - data.vacationPrev.size) > 0) data.vacationPrev.add(k);
      else data.vacation.add(k);
    });
  }
  
  delete carryOver[year];
  saveData();
  createCalendar(year);
}

function updateCounters(){
  const data = yearData[currentYear] || {vacation:new Set(), vacationPrev:new Set(), medical:new Set()};
  const carry = calculateCarryOver(currentYear - 1);
  vacationCount.textContent = data.vacation.size;
  vacationPrevCount.textContent = `${data.vacationPrev.size} (de ${carry})`;
  medicalCount.textContent = data.medical.size;
  remaining.textContent = (vacationLimit + carry) - (data.vacation.size + data.vacationPrev.size);
}

document.getElementById("prevYear").onclick = () => createCalendar(currentYear - 1);
document.getElementById("nextYear").onclick = () => createCalendar(currentYear + 1);
document.getElementById("yearInput").onchange = (e) => createCalendar(parseInt(e.target.value));
document.getElementById("resetYear").onclick = () => {
  if(confirm("Borrar todo el año?")) {
    yearData[currentYear] = { vacation: new Set(), vacationPrev: new Set(), medical: new Set() };
    saveData(); createCalendar(currentYear);
  }
};
</script>
</body>
</html>
