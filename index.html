<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario Vacaciones</title>
  <link rel="icon" href="playa.png" type="image/png" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin:0; padding:1rem; background-color:#f0f8ff; }
    h1 { text-align:center; margin-bottom:0.5rem; }
    .year-selector { text-align:center; margin-bottom:1rem; }
    .counters { text-align:center; margin-bottom:1rem; font-weight:bold; }
    .calendar { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap:1rem; }
    .month { background-color:#fff; border-radius:10px; padding:0.5rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .month h2 { text-align:center; margin-top:0; }
    .days { display:grid; grid-template-columns: repeat(7,1fr); gap:3px; font-size:0.8rem; }
    .day { border:1px solid #ccc; padding:0.4rem; text-align:center; cursor:pointer; border-radius:4px; }
    .vacation { background-color:#FFCC80; }
    .vacation-prev { background-color:#FFA726; font-weight:bold; color:#000; }
    .medical { background-color:#90CAF9; }
    .holiday-national { background-color:#F28B82; }
    .holiday-local { background-color:#E1BEE7; }
    .weekend { background-color:#EEEEEE; }
    .today { border:3px solid #3f51b5; box-sizing:border-box; }
    .labels { display:flex; justify-content:center; gap:1rem; margin:1.5rem 0; font-size:0.9rem; flex-wrap:wrap; }
    .labels span { display:inline-flex; align-items:center; gap:0.3rem; }
    .dot { width:1rem; height:1rem; border-radius:50%; display:inline-block; }
    .vacation-dot { background-color:#FFCC80; }
    .vacation-prev-dot { background-color:#FFA726; }
    .medical-dot { background-color:#90CAF9; }
    .holiday-national-dot { background-color:#F28B82; }
    .holiday-local-dot { background-color:#E1BEE7; }
    .weekend-dot { background-color:#EEEEEE; }
    @media (max-width:600px){ .days{ font-size:0.7rem; } }
  </style>
</head>
<body>
  <h1>Calendario Vacaciones</h1>
  
  <div class="year-selector">
    <button id="prevYear">« Año anterior</button>
    <input type="number" id="yearInput" min="2000" max="2100" style="width:80px; text-align:center;">
    <button id="nextYear">Año siguiente »</button>
  </div>
  
  <div class="counters">
    <p id="vacationCount">Días de vacaciones usados (año actual): 0</p>
    <p id="vacationPrevCount">Días de vacaciones año anterior usados: 0 / 0</p>
    <p id="medicalCount">Días médicos: 0</p>
    <p id="remaining">Vacaciones restantes: 23</p>
  </div>
  
  <div class="labels">
    <span><span class="dot vacation-dot"></span> Vacaciones</span>
    <span><span class="dot vacation-prev-dot"></span> Vacaciones año anterior (AN)</span>
    <span><span class="dot medical-dot"></span> Médico</span>
    <span><span class="dot holiday-national-dot"></span> Festivo Nacional</span>
    <span><span class="dot holiday-local-dot"></span> Festivo Local</span>
    <span><span class="dot weekend-dot"></span> Fin de semana</span>
  </div>
  
  <div class="calendar" id="calendar"></div>

  <script>
    const vacationLimit = 23;
    const vacationCount = document.getElementById("vacationCount");
    const vacationPrevCount = document.getElementById("vacationPrevCount");
    const medicalCount = document.getElementById("medicalCount");
    const remaining = document.getElementById("remaining");
    const yearInput = document.getElementById("yearInput");
    const calendar = document.getElementById("calendar");
    
    const dayNames = ["L","M","X","J","V","S","D"];
    const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    
    let currentYear = new Date().getFullYear();
    let yearData = {};        // Se cargará desde localStorage
    let carryOver = {};       // También se guardará

    // ====================== LOCALSTORAGE ======================
    function loadData() {
      const saved = localStorage.getItem('vacationCalendarData');
      if (saved) {
        const parsed = JSON.parse(saved);
        yearData = parsed.yearData || {};
        carryOver = parsed.carryOver || {};
        
        // Convertir Sets de vuelta a Sets
        Object.keys(yearData).forEach(year => {
          const y = yearData[year];
          if (y.vacation) y.vacation = new Set(y.vacation);
          if (y.medical) y.medical = new Set(y.medical);
        });
      }
    }

    function saveData() {
      const toSave = {
        yearData: {},
        carryOver: carryOver
      };

      // Convertir Sets a arrays para guardar en localStorage
      Object.keys(yearData).forEach(year => {
        const y = yearData[year];
        toSave.yearData[year] = {
          vacation: Array.from(y.vacation || []),
          medical: Array.from(y.medical || []),
          vacationPrevUsed: y.vacationPrevUsed || 0
        };
      });

      localStorage.setItem('vacationCalendarData', JSON.stringify(toSave));
    }

    // ====================== FESTIVOS ======================
    function getFixedHolidays(year) {
      const fixed = [
        {month:1,day:1}, {month:1,day:6}, {month:5,day:1},
        {month:8,day:15}, {month:10,day:12}, {month:11,day:1},
        {month:12,day:6}, {month:12,day:8}, {month:12,day:25}
      ];
      return fixed.map(f => {
        let date = new Date(year, f.month-1, f.day);
        if (f.month === 10 && f.day === 12 && date.getDay() === 0) date.setDate(13);
        return formatDate(date);
      });
    }

    function getEasterSunday(year) {
      const f = Math.floor;
      const G = year % 19;
      const C = f(year / 100);
      const H = (C - f(C/4) - f((8*C + 13)/25) + 19*G + 15) % 30;
      const I = H - f(H/28) * (1 - f(H/28) * f(29/(H+1)) * f((21-G)/11));
      const J = (year + f(year/4) + I + 2 - C + f(C/4)) % 7;
      const L = I - J;
      const month = 3 + f((L + 40)/44);
      const day = L + 28 - 31 * f(month/4);
      return new Date(year, month-1, day);
    }

    function getEasterRelatedHolidays(year) {
      const easter = getEasterSunday(year);
      const thursday = new Date(easter);
      thursday.setDate(easter.getDate() - 3);
      const friday = new Date(easter);
      friday.setDate(easter.getDate() - 2);
      return [formatDate(thursday), formatDate(friday)];
    }

    function getLocalHolidays(year) {
      const holidays = [];
      holidays.push(formatDate(new Date(year, 5, 24))); // 24 junio
      holidays.push(formatDate(new Date(year, 3, 23))); // 23 abril - Castilla y León
      
      let sanFroilan = new Date(year, 9, 5);
      if (sanFroilan.getDay() === 0) sanFroilan.setDate(6);
      holidays.push(formatDate(sanFroilan));
      
      return holidays;
    }

    function getHolidaySets(year) {
      return {
        national: new Set([...getFixedHolidays(year), ...getEasterRelatedHolidays(year)]),
        local: new Set(getLocalHolidays(year))
      };
    }

    function formatDate(date) {
      return `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
    }

    function getTodayKey() {
      const today = new Date();
      return formatDate(today);
    }

    // ====================== CALENDARIO ======================
    function createCalendar(year) {
      currentYear = year;
      yearInput.value = year;

      const {national: nationalHolidays, local: localHolidays} = getHolidaySets(year);

      if (!yearData[year]) {
        yearData[year] = {
          vacation: new Set(),
          medical: new Set(),
          vacationPrevUsed: 0
        };
      }

      // Calcular carryOver del año anterior si no existe
      const prevYear = year - 1;
      if (carryOver[prevYear] === undefined) {
        const prevData = yearData[prevYear];
        if (prevData) {
          const used = prevData.vacation.size;
          const previousCarry = carryOver[prevYear - 1] || 0;
          const leftover = previousCarry + vacationLimit - used;
          carryOver[prevYear] = Math.max(0, leftover);
        } else {
          carryOver[prevYear] = 0;
        }
        saveData(); // Guardar el nuevo carryOver
      }

      calendar.innerHTML = "";

      for (let m = 0; m < 12; m++) {
        const firstDay = new Date(year, m, 1).getDay();
        const totalDays = new Date(year, m + 1, 0).getDate();

        const monthDiv = document.createElement("div");
        monthDiv.className = "month";

        const title = document.createElement("h2");
        title.textContent = months[m];
        monthDiv.appendChild(title);

        const daysDiv = document.createElement("div");
        daysDiv.className = "days";

        dayNames.forEach(d => {
          const label = document.createElement("div");
          label.className = "day";
          label.style.fontWeight = "bold";
          label.textContent = d;
          daysDiv.appendChild(label);
        });

        const startDay = (firstDay + 6) % 7;
        for (let i = 0; i < startDay; i++) {
          daysDiv.appendChild(document.createElement("div"));
        }

        for (let d = 1; d <= totalDays; d++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "day";
          dayDiv.textContent = d;

          const dateKey = `${year}-${m+1}-${d}`;
          dayDiv.dataset.date = dateKey;

          const dateObj = new Date(year, m, d);
          const dayOfWeek = dateObj.getDay();

          if (dateKey === getTodayKey()) dayDiv.classList.add("today");

          if (nationalHolidays.has(dateKey)) {
            dayDiv.classList.add("holiday-national");
          } else if (localHolidays.has(dateKey)) {
            dayDiv.classList.add("holiday-local");
          } else if (dayOfWeek === 0 || dayOfWeek === 6) {
            dayDiv.classList.add("weekend");
          } else {
            dayDiv.addEventListener("click", () => handleDayClick(dayDiv, dateObj, dateKey));
          }

          // Marcar vacaciones guardadas
          const data = yearData[year];
          if (data.vacation.has(dateKey)) {
            dayDiv.classList.add("vacation");
          }
          if (data.medical.has(dateKey)) {
            dayDiv.classList.add("medical");
          }

          daysDiv.appendChild(dayDiv);
        }

        monthDiv.appendChild(daysDiv);
        calendar.appendChild(monthDiv);
      }

      applyPrevYearMarkings(); // Aplicar marcas visuales de días AN
      updateCounters();
    }

    function applyPrevYearMarkings() {
      const data = yearData[currentYear];
      const usedPrev = data.vacationPrevUsed || 0;
      if (usedPrev === 0) return;

      // Recorrer todos los días marcados como vacation y los primeros 'usedPrev' los marcamos como AN
      const vacationDays = document.querySelectorAll('.day.vacation');
      let count = 0;
      vacationDays.forEach(div => {
        if (count < usedPrev) {
          div.classList.remove('vacation');
          div.classList.add('vacation-prev');
          div.textContent = div.textContent.trim() + " AN";
          count++;
        }
      });
    }

    // ====================== CLICK EN DÍA ======================
    function handleDayClick(dayDiv, dateObj, dateKey) {
      const year = dateObj.getFullYear();
      const data = yearData[year];
      const carryAvailable = carryOver[year - 1] || 0;
      const usedPrev = data.vacationPrevUsed || 0;

      const isVacation = dayDiv.classList.contains("vacation");
      const isVacationPrev = dayDiv.classList.contains("vacation-prev");
      const isMedical = dayDiv.classList.contains("medical");

      if (isVacation || isVacationPrev || isMedical) {
        // Desmarcar
        dayDiv.classList.remove("vacation", "vacation-prev", "medical");
        dayDiv.textContent = dateObj.getDate();

        if (isVacation) {
          data.vacation.delete(dateKey);
        } else if (isVacationPrev) {
          data.vacationPrevUsed = Math.max(0, usedPrev - 1);
        } else if (isMedical) {
          data.medical.delete(dateKey);
        }
      } else {
        const type = prompt("¿Qué quieres marcar?\n\nv = vacaciones\nm = médico", "v").toLowerCase().trim();

        if (type === "v") {
          let usePrev = false;
          if (carryAvailable > usedPrev) {
            usePrev = confirm(`Tienes ${carryAvailable - usedPrev} días de vacaciones del año anterior disponibles.\n¿Quieres usar uno para este día?`);
          }

          const dayOfWeek = dateObj.getDay();
          let markWeek = false;
          if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            markWeek = confirm("¿Quieres marcar vacaciones desde hoy hasta el viernes de esta semana?");
          }

          if (markWeek) {
            for (let dow = dayOfWeek; dow <= 5; dow++) {
              const tempDate = new Date(dateObj);
              tempDate.setDate(dateObj.getDate() + (dow - dayOfWeek));
              const tempKey = formatDate(tempDate);
              const tempDiv = document.querySelector(`.day[data-date="${tempKey}"]`);
              if (!tempDiv || tempDiv.classList.contains('holiday-national') || 
                  tempDiv.classList.contains('holiday-local') || 
                  tempDiv.classList.contains('weekend')) continue;

              if (usePrev && (carryAvailable - usedPrev > 0)) {
                tempDiv.classList.add("vacation-prev");
                tempDiv.textContent = tempDate.getDate() + " AN";
                data.vacationPrevUsed++;
              } else {
                tempDiv.classList.add("vacation");
                data.vacation.add(tempKey);
              }
            }
          } else {
            if (usePrev && (carryAvailable - usedPrev > 0)) {
              dayDiv.classList.add("vacation-prev");
              dayDiv.textContent = dateObj.getDate() + " AN";
              data.vacationPrevUsed++;
            } else {
              dayDiv.classList.add("vacation");
              data.vacation.add(dateKey);
            }
          }
        } else if (type === "m") {
          dayDiv.classList.add("medical");
          data.medical.add(dateKey);
        }
      }

      saveData();
      updateCounters();
      applyPrevYearMarkings(); // Volver a aplicar marcas visuales AN
    }

    // ====================== CONTADORES ======================
    function updateCounters() {
      const data = yearData[currentYear] || {vacation: new Set(), medical: new Set(), vacationPrevUsed: 0};
      const carryAvailable = carryOver[currentYear - 1] || 0;
      const usedPrev = data.vacationPrevUsed || 0;

      vacationCount.textContent = `Días de vacaciones usados (año actual): ${data.vacation.size}`;
      vacationPrevCount.textContent = `Días de vacaciones año anterior usados: ${usedPrev} / ${carryAvailable}`;
      medicalCount.textContent = `Días médicos: ${data.medical.size}`;
      remaining.textContent = `Vacaciones restantes: ${vacationLimit - data.vacation.size + (carryAvailable - usedPrev)}`;
    }

    // ====================== NAVEGACIÓN ======================
    document.getElementById("prevYear").addEventListener("click", () => createCalendar(currentYear - 1));
    document.getElementById("nextYear").addEventListener("click", () => createCalendar(currentYear + 1));
    yearInput.addEventListener("change", () => {
      const y = parseInt(yearInput.value);
      if (y >= 2000 && y <= 2100) createCalendar(y);
    });

    // Inicializar
    loadData();
    createCalendar(currentYear);
  </script>
</body>
</html>
