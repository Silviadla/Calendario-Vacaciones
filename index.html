<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calendario Vacaciones León</title>
<link rel="icon" href="playa.png" type="image/png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f4f8;
    --card-bg: #ffffff;
    --text: #2d3748;
    --border: #e2e8f0;
    --primary: #4c6ef5;
    --vacation: #5c7cfa;
    --vacation-prev: #7950f2;
    --medical: #20c997;
    --holiday-national: #fca5a5;
    --holiday-local: #c4b5fd;
    --weekend: #dbeafe;
    --shadow: 0 6px 16px rgba(0,0,0,0.08);
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a202c;
      --card-bg: #2d3748;
      --text: #e2e8f0;
      --border: #4a5568;
      --holiday-national: #ef4444;
      --holiday-local: #a78bfa;
      --weekend: #1e3a8a;
      --shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body { 
    font-family: 'Inter', sans-serif; 
    background: var(--bg);
    color: var(--text);
    padding: 1.5rem 1rem;
    line-height: 1.6;
    min-height: 100vh;
  }
  h1 { 
    text-align: center; 
    font-size: 2.2rem; 
    font-weight: 600;
    margin-bottom: 2rem;
    color: var(--primary);
  }
  .year-selector { 
    text-align: center; 
    margin-bottom: 1.5rem; 
  }
  .year-selector button { 
    padding: 0.7rem 1.4rem; 
    margin: 0 0.4rem; 
    border: 1px solid var(--border); 
    background: var(--card-bg); 
    color: var(--text); 
    border-radius: 12px; 
    cursor: pointer; 
    font-weight: 500;
    transition: all 0.3s;
  }
  .year-selector button:hover { 
    background: var(--primary); 
    color: white; 
    border-color: var(--primary);
  }
  .year-selector input { 
    padding: 0.7rem; 
    width: 100px; 
    text-align: center; 
    border: 1px solid var(--border); 
    background: var(--card-bg);
    border-radius: 12px; 
    font-size: 1.1rem;
    font-weight: 500;
  }
  /* CONTADORES COMPACTOS Y RESPONSIVE */
  .counters { 
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.8rem; 
    margin: 1.5rem 0;
    justify-items: center;
  }
  .counter-box {
    background: var(--card-bg);
    padding: 0.8rem 1rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    width: 100%;
    max-width: 180px;
    text-align: center;
    border: 1px solid var(--border);
    transition: transform 0.3s;
  }
  .counter-box:hover { transform: translateY(-3px); }
  .counter-box div { 
    font-size: 0.78rem; 
    opacity: 0.85; 
    margin-bottom: 0.3rem;
    font-weight: 500;
  }
  .counter-box strong { 
    font-size: 1.6rem; 
    font-weight: 700; 
  }
  .big-remaining {
    font-size: 2rem !important; 
    color: var(--primary);
    font-weight: 700;
  }
  #resetYear {
    display: block;
    margin: 2rem auto;
    padding: 0.8rem 2rem;
    background: #e53e3e;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: var(--shadow);
    transition: all 0.3s;
  }
  #resetYear:hover { 
    background: #c53030; 
    transform: translateY(-3px);
  }
  .labels { 
    display: flex; 
    justify-content: center; 
    gap: 1rem; 
    margin: 2rem 0; 
    flex-wrap: wrap; 
    font-size: 0.92rem;
    font-weight: 500;
    text-align: center;
  }
  .labels span { 
    display: flex; 
    align-items: center; 
    gap: 0.6rem; 
  }
  .dot {
    width: 1rem; height: 1rem; border-radius: 50%; display: inline-block;
  }
  .calendar { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    gap: 1.5rem; 
  }
  .month { 
    background: var(--card-bg);
    border-radius: 20px; 
    padding: 1.5rem; 
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .month h2 { 
    text-align: center; 
    margin-bottom: 1rem; 
    font-size: 1.4rem; 
    font-weight: 600;
    color: var(--primary);
  }
  .days { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 8px; 
    font-size: 0.9rem; 
  }
  .day { 
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    border: 1px solid transparent;
  }
  .day:hover { 
    transform: scale(1.1); 
    box-shadow: 0 6px 16px rgba(0,0,0,0.12); 
    z-index: 5;
  }
  .vacation { background: var(--vacation); color: white; }
  .vacation-prev { background: var(--vacation-prev); color: white; font-weight: bold; }
  .medical { background: var(--medical); color: white; }
  .holiday-national { background: var(--holiday-national); color: #7f1d1d; font-weight: 500; }
  .holiday-local { background: var(--holiday-local); color: #4c1d95; font-weight: 500; }
  .weekend { background: var(--weekend); color: var(--text); opacity: 0.9; }
  .today { 
    border: 4px solid var(--primary) !important; 
    font-weight: bold;
    box-shadow: 0 0 20px rgba(76, 110, 245, 0.4);
  }
  .tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #2d3748;
    color: white;
    padding: 0.7rem 1rem;
    border-radius: 10px;
    font-size: 0.85rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 10;
    margin-bottom: 10px;
  }
  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -6px;
    border: 6px solid transparent;
    border-top-color: #2d3748;
  }
  .day.holiday-national:hover .tooltip,
  .day.holiday-local:hover .tooltip { opacity: 1; }
  @media (max-width: 768px) {
    h1 { font-size: 2rem; }
    .calendar { grid-template-columns: 1fr; }
    .counters { grid-template-columns: 1fr 1fr; gap: 0.8rem; }
    .counter-box { min-width: auto; padding: 0.8rem; }
    .big-remaining { font-size: 1.8rem; }
    .labels { gap: 0.8rem; font-size: 0.9rem; }
  }
  @media (max-width: 480px) {
    .counters { grid-template-columns: 1fr; }
    .year-selector button { padding: 0.6rem 1.2rem; margin: 0 0.3rem; font-size: 0.9rem; }
  }
</style>
</head>
<body>
<h1>Calendario Vacaciones León</h1>
<div class="year-selector">
  <button id="prevYear">« Año anterior</button>
  <input type="number" id="yearInput" value="2026" min="2000" max="2100">
  <button id="nextYear">Año siguiente »</button>
</div>
<div class="counters">
  <div class="counter-box">
    <div>Días usados (año actual)</div>
    <strong id="vacationCount">0</strong>
  </div>
  <div class="counter-box">
    <div>Días año anterior usados</div>
    <strong id="vacationPrevCount">0</strong>
  </div>
  <div class="counter-box">
    <div>Días médicos</div>
    <strong id="medicalCount">0</strong>
  </div>
  <div class="counter-box">
    <div>Días totales disponibles</div>
    <strong id="remaining" class="big-remaining">23</strong>
  </div>
</div>
<button id="resetYear">Borrar todas las marcas de este año</button>
<div class="labels">
  <span><span class="dot" style="background:var(--vacation);"></span> Vacaciones año actual</span>
  <span><span class="dot" style="background:var(--vacation-prev);"></span> Vacaciones año anterior (AN)</span>
  <span><span class="dot" style="background:var(--medical);"></span> Médico</span>
  <span><span class="dot" style="background:var(--holiday-national);"></span> Festivo Nacional</span>
  <span><span class="dot" style="background:var(--holiday-local);"></span> Festivo Local / Trasladado</span>
  <span><span class="dot" style="background:var(--weekend);"></span> Fin de semana</span>
</div>
<div class="calendar" id="calendar"></div>

<script>
let currentYear = new Date().getFullYear();
const vacationLimit = 23;
const vacationCount = document.getElementById("vacationCount");
const vacationPrevCount = document.getElementById("vacationPrevCount");
const medicalCount = document.getElementById("medicalCount");
const remaining = document.getElementById("remaining");
const yearInput = document.getElementById("yearInput");
const calendar = document.getElementById("calendar");
const dayNames = ["L","M","X","J","V","S","D"];
const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

let yearData = {};      
let carryOver = {};     

function getFixedHolidays(year){
  const fixed = [
    {month:1,day:1},{month:1,day:6},{month:5,day:1},
    {month:8,day:15},{month:10,day:12},{month:11,day:1},
    {month:12,day:6},{month:12,day:8},{month:12,day:25}
  ];
  return fixed.map(f=>{
    let date = new Date(year, f.month-1, f.day);
    if (f.month === 10 && f.day === 12 && date.getDay() === 0) date.setDate(13);
    return `${year}-${date.getMonth()+1}-${date.getDate()}`;
  });
}

function getEasterSunday(year){
  const f=Math.floor,G=year%19,C=f(year/100),H=(C-f(C/4)-f((8*C+13)/25)+19*G+15)%30,
  I=H-f(H/28)*(1-f(H/28)*f(29/(H+1))*f((21-G)/11)),J=(year+f(year/4)+I+2-C+f(C/4))%7,
  L=I-J,month=3+f((L+40)/44),day=L+28-31*f(month/4);
  return new Date(year,month-1,day);
}

function getEasterRelatedHolidays(year){
  const easter=getEasterSunday(year);
  const thursday=new Date(easter); thursday.setDate(easter.getDate()-3);
  const friday=new Date(easter); friday.setDate(easter.getDate()-2);
  return [`${year}-${thursday.getMonth()+1}-${thursday.getDate()}`,`${year}-${friday.getMonth()+1}-${friday.getDate()}`];
}

function getLocalAndTransferredHolidays(year){
  const holidays = new Set();

  holidays.add(`${year}-4-23`);
  holidays.add(`${year}-6-24`);

  let sanFroilan = new Date(year, 9, 5);
  if (sanFroilan.getDay() === 0) sanFroilan.setDate(6);
  holidays.add(`${year}-${sanFroilan.getMonth()+1}-${sanFroilan.getDate()}`);

  const dec6 = new Date(year, 11, 6);
  if (dec6.getDay() === 0) holidays.add(`${year}-12-7`);

  const nov1 = new Date(year, 10, 1);
  if (nov1.getDay() === 0) holidays.add(`${year}-11-2`);

  return holidays;
}

function getHolidaySets(year){
  return { 
    national: new Set([...getFixedHolidays(year), ...getEasterRelatedHolidays(year)]),
    local: getLocalAndTransferredHolidays(year)
  };
}

function loadData() {
  const saved = localStorage.getItem('calendarData');
  if (saved) {
    const parsed = JSON.parse(saved);
    for (const y in parsed.yearData) {
      yearData[y] = {
        vacation: new Set(parsed.yearData[y].vacation || []),
        vacationPrev: new Set(parsed.yearData[y].vacationPrev || []),
        medical: new Set(parsed.yearData[y].medical || [])
      };
    }
    carryOver = parsed.carryOver || {};
  }
}
function saveData() {
  const toSave = {
    yearData: {},
    carryOver: carryOver
  };
  for (const y in yearData) {
    toSave.yearData[y] = {
      vacation: Array.from(yearData[y].vacation),
      vacationPrev: Array.from(yearData[y].vacationPrev),
      medical: Array.from(yearData[y].medical)
    };
  }
  localStorage.setItem('calendarData', JSON.stringify(toSave));
}

function calculateCarryOver(year) {
  if (carryOver[year] !== undefined) return carryOver[year];
  if (!yearData[year]) {
    carryOver[year] = 0;
    return 0;
  }
  const data = yearData[year];
  const totalUsed = data.vacation.size + data.vacationPrev.size;
  const prevCarry = calculateCarryOver(year - 1);
  const totalAvailable = vacationLimit + prevCarry;
  const leftover = totalAvailable - totalUsed;
  carryOver[year] = Math.max(0, leftover);
  return carryOver[year];
}

function ensureCarryOverUpTo(prevYear) {
  for (let y = 2025; y <= prevYear; y++) {
    calculateCarryOver(y);
  }
}

function createCalendar(year){
  currentYear = year;
  yearInput.value = year;

  ensureCarryOverUpTo(year - 1);

  const holidays = getHolidaySets(year);
  const nationalHolidays = holidays.national;
  const localHolidays = holidays.local;

  if (!yearData[year]) {
    yearData[year] = { vacation: new Set(), vacationPrev: new Set(), medical: new Set() };
  }

  calendar.innerHTML = "";
  for(let m = 0; m < 12; m++){
    const firstDay = new Date(year, m, 1).getDay();
    const totalDays = new Date(year, m+1, 0).getDate();

    const monthDiv = document.createElement("div");
    monthDiv.className = "month";
    const title = document.createElement("h2");
    title.textContent = months[m];
    monthDiv.appendChild(title);

    const daysDiv = document.createElement("div");
    daysDiv.className = "days";

    dayNames.forEach(d => {
      const label = document.createElement("div");
      label.className = "day";
      label.style.fontWeight = "bold";
      label.textContent = d;
      daysDiv.appendChild(label);
    });

    const startDay = (firstDay + 6) % 7;
    for(let i = 0; i < startDay; i++) daysDiv.appendChild(document.createElement("div"));

    for(let d = 1; d <= totalDays; d++){
      const dayDiv = document.createElement("div");
      dayDiv.className = "day";
      dayDiv.textContent = d;
      const dateKey = `${year}-${m+1}-${d}`;
      dayDiv.dataset.date = dateKey;

      const dayOfWeek = new Date(year, m, d).getDay();

      if (dateKey === getTodayKey()) dayDiv.classList.add("today");

      if (nationalHolidays.has(dateKey)) {
        dayDiv.classList.add("holiday-national");
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        tooltip.textContent = "Festivo Nacional";
        dayDiv.appendChild(tooltip);
      } else if (localHolidays.has(dateKey)) {
        dayDiv.classList.add("holiday-local");
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        let name = "Festivo Local";
        if (dateKey.includes("-10-")) name = "San Froilán" + (dateKey.endsWith("-6") ? " (trasladado)" : "");
        else if (dateKey === `${year}-4-23`) name = "Día de Castilla y León";
        else if (dateKey === `${year}-6-24`) name = "San Juan";
        else if (dateKey === `${year}-12-7`) name = "Constitución (trasladado)";
        else if (dateKey === `${year}-11-2`) name = "Todos los Santos (trasladado)";
        tooltip.textContent = name;
        dayDiv.appendChild(tooltip);
      } else if (dayOfWeek === 0 || dayOfWeek === 6) {
        dayDiv.classList.add("weekend");
      } else {
        dayDiv.addEventListener("click", () => handleDayClick(dayDiv, year, m, d));
      }

      if (yearData[year].vacationPrev.has(dateKey)) {
        dayDiv.classList.add("vacation-prev");
        dayDiv.textContent = d + " AN";
      } else if (yearData[year].vacation.has(dateKey)) {
        dayDiv.classList.add("vacation");
      }
      if (yearData[year].medical.has(dateKey)) dayDiv.classList.add("medical");

      daysDiv.appendChild(dayDiv);
    }
    monthDiv.appendChild(daysDiv);
    calendar.appendChild(monthDiv);
  }
  updateCounters();
}

function getAvailableVacationDays() {
  const data = yearData[currentYear] || {vacation: new Set(), vacationPrev: new Set()};
  const carry = carryOver[currentYear - 1] || 0;
  const usedPrev = data.vacationPrev.size;
  const usedNormal = data.vacation.size;
  return carry - usedPrev + vacationLimit - usedNormal;
}

function getTodayKey(){
  const today = new Date();
  return `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
}

function handleDayClick(dayDiv, year, month, day){
  const dateKey = `${year}-${month+1}-${day}`;
  const data = yearData[year];

  if (dayDiv.classList.contains("vacation") || dayDiv.classList.contains("vacation-prev") || dayDiv.classList.contains("medical")) {
    dayDiv.classList.remove("vacation", "vacation-prev", "medical");
    data.vacation.delete(dateKey);
    data.vacationPrev.delete(dateKey);
    data.medical.delete(dateKey);
    dayDiv.textContent = day;
    delete carryOver[year];
    updateCounters();
    saveData();
    return;
  }

  const type = prompt("¿Qué quieres marcar? (v = vacaciones, m = médico)").toLowerCase().trim();
  if (type !== "v" && type !== "m") return;

  if (type === "m") {
    data.medical.add(dateKey);
    dayDiv.classList.add("medical");
    updateCounters();
    saveData();
    return;
  }

  const available = getAvailableVacationDays();
  if (available <= 0) {
    alert("No te quedan días de vacaciones disponibles.");
    return;
  }

  const carry = carryOver[year - 1] || 0;
  const usedPrev = data.vacationPrev.size;
  const remainingCarry = carry - usedPrev;

  let usePrev = false;
  if (remainingCarry > 0) {
    usePrev = confirm(`Tienes ${remainingCarry} días del año anterior disponibles. ¿Quieres usar uno de ellos?`);
  } else {
    alert(`No quedan días del año anterior. Se usará del año actual.`);
  }

  const dayOfWeek = new Date(year, month, day).getDay();
  let markWeek = false;
  if (dayOfWeek >= 1 && dayOfWeek <= 5) {
    markWeek = confirm("¿Quieres marcar vacaciones hasta el viernes de esta semana?");
  }

  let daysToMark = [];
  if (markWeek) {
    for (let i = dayOfWeek; i <= 5; i++) {
      const tempDate = new Date(year, month, day + (i - dayOfWeek));
      if (tempDate.getFullYear() !== year) {
        alert("La semana cruza al siguiente año. Se marcará solo el día seleccionado.");
        markWeek = false;
        break;
      }
      const tempKey = `${year}-${tempDate.getMonth()+1}-${tempDate.getDate()}`;
      const tempDow = tempDate.getDay();
      if (tempDow === 0 || tempDow === 6) continue;
      if (getHolidaySets(year).national.has(tempKey) || getHolidaySets(year).local.has(tempKey)) continue;
      const div = document.querySelector(`.day[data-date='${tempKey}']`);
      daysToMark.push({key: tempKey, div: div, num: tempDate.getDate()});
    }
  } else {
    daysToMark.push({key: dateKey, div: dayDiv, num: day});
  }

  if (daysToMark.length > available) {
    alert(`No tienes suficientes días. Necesitas ${daysToMark.length} pero solo quedan ${available}.`);
    return;
  }

  let prevToUse = usePrev ? Math.min(daysToMark.length, remainingCarry) : 0;
  daysToMark.forEach(item => {
    if (prevToUse > 0) {
      data.vacationPrev.add(item.key);
      item.div.classList.add("vacation-prev");
      item.div.textContent = item.num + " AN";
      prevToUse--;
    } else {
      data.vacation.add(item.key);
      item.div.classList.add("vacation");
    }
  });

  delete carryOver[year];
  updateCounters();
  saveData();
}

function updateCounters(){
  ensureCarryOverUpTo(currentYear - 1);
  const data = yearData[currentYear] || {vacation: new Set(), vacationPrev: new Set(), medical: new Set()};
  const carry = carryOver[currentYear - 1] || 0;
  const usedPrev = data.vacationPrev.size;

  vacationCount.textContent = data.vacation.size;
  vacationPrevCount.textContent = `${usedPrev} (de ${carry} disponibles)`;
  medicalCount.textContent = data.medical.size;
  remaining.textContent = getAvailableVacationDays();
}

document.getElementById("resetYear").addEventListener("click", () => {
  if (confirm(`¿Seguro que quieres borrar TODAS las marcas de ${currentYear}?`)) {
    yearData[currentYear] = { vacation: new Set(), vacationPrev: new Set(), medical: new Set() };
    saveData();
    createCalendar(currentYear);
  }
});

loadData();
document.getElementById("prevYear").addEventListener("click", () => createCalendar(currentYear - 1));
document.getElementById("nextYear").addEventListener("click", () => createCalendar(currentYear + 1));
yearInput.addEventListener("change", () => createCalendar(parseInt(yearInput.value)));

createCalendar(currentYear);
</script>
</body>
</html>
